#!/usr/bin/env Rscript
# to run locally:
# SCRATCH1=/mnt/g/scratch
# docker run -it \
# --workdir $HOME \
# -v /mnt/g/diabneph:$HOME/project \
# -v $HOME:$HOME \
# -v $SCRATCH1:$SCRATCH1 \
# -e SCRATCH1="/mnt/g/scratch" \
# p4rkerw/sctools:R4.1.0

# to run interactively on the RIS compute1 cluster
# export LSF_DOCKER_VOLUMES="$HOME:$HOME \
# $STORAGE1/diabneph:$HOME/project \
# $SCRATCH1:$SCRATCH1"
# bsub -Is -G compute-parkerw -R 'rusage[mem=64GB]' -q general-interactive -a 'docker(p4rkerw/sctools:R4.1.0)' /bin/bash

library(here)
library(Signac)
library(stringr)
library(data.table)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(openxlsx)
library(tibble)
library(ComplexHeatmap)
library(Seurat)

figures <- here("project","analysis","dkd","figures")
dir.create(here(figures), showWarnings=FALSE)

#################################################
# supplemental figure number peaks by cell type
files <- list.files(here("project","analysis","dkd","atac_aggr_prep","macs2"), pattern = "narrowPeak", full.names = TRUE)
idents <- str_split(basename(files), pattern="_", simplify = TRUE)[,1]

peaks <- lapply(seq(files), function(index){
  file <- files[index]
  ident <- idents[index]
  # qval FDR < 0.05
  df <- fread(file) %>%
    dplyr::filter(V10 > 1.3) %>% 
    as.data.frame()
  df$ident <- ident
  return(df)
}) %>% bind_rows()

atacAggr <- readRDS(here("project","analysis","dkd","atac_aggr_prep","step5_chromVAR.rds"))
num_cells <- table(atacAggr@meta.data$celltype) %>% as.data.frame()
colnames(num_cells)[1] <- "celltype"
colnames(num_cells)[2] <- "num_cells"

# change TCELL and BCELL to LYMPH
# and change FIB_VSMC_MC to MESFIB
# remove PT_CD36
metadata <- atacAggr@meta.data %>% as.data.frame()
metadata <- dplyr::mutate(metadata, celltype_update = ifelse(celltype == "TCELL" | celltype == "BCELL","LYMPH",as.character(celltype)))
metadata <- dplyr::filter(metadata, celltype != "PT_CD36")
num_cells <- table(metadata$celltype_update) %>% 
  as.data.frame() %>%
  rename(celltype = Var1)

num_peaks <- table(peaks$ident) %>%
  as.data.frame()
colnames(num_peaks)[1] <- "celltype"
colnames(num_peaks)[2] <- "num_peaks"
num_peaks <- dplyr::mutate(num_peaks, celltype = ifelse(celltype == "MESFIB","FIB_VSMC_MC",as.character(celltype)))
num_peaks <- dplyr::mutate(num_peaks, celltype = ifelse(celltype == "PTVCAM1","PT_VCAM1",as.character(celltype)))

toplot <- merge(num_peaks, num_cells, by = "celltype")

levels <- c("PCT","PST","PT_VCAM1","PEC","ATL",
            "TAL1","TAL2","DCT1","DCT2","PC",
            "ICA","ICB","ENDO","PODO","FIB_VSMC_MC",
            "LYMPH","MONO")
toplot$celltype <- factor(toplot$celltype, levels=levels)
pdf(here(figures,"sfigure1.pdf"), width=10, height=6)
ggplot(toplot, aes(x=Freq, y=num_peaks, color=celltype, label=celltype)) +
  geom_point() +
  geom_text_repel(aes(label=celltype)) +
  theme_bw() +
  xlab("Number of Cells") +
  ylab("Number of Peaks")
dev.off()
###########################################################
# supplemental figure dotplot of atacAggr gene activity and imputed RNA markers
levels(atacAggr) <- rev(levels(atacAggr))
features <- c("SLC34A1","LRP2","SLC5A1","SLC5A2","HAVCR1",
              "VCAM1","CD36","CFH","SLC12A1","CLDN16","SLC12A3",
              "AQP2","SLC26A7","SLC26A4","NPHS2","FLT1",
              "PIEZO2","COL1A2","PTPRC","CD3E","MS4A1","CSF1R")
p1 <- DotPlot(atacAggr, assay="RNA", features = features, cols = c("lightyellow","royalblue")) +
  RotatedAxis() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) #820x600
p2 <- DotPlot(atacAggr, assay="IMPRNA", features = features, cols = c("lightyellow","royalblue")) +
  RotatedAxis() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) #820x600
pdf(here(figures,"sfigure2.pdf"), width=10, height=6)
list(p1,p2)
dev.off()
###########################################################3
# supplemental figure dotplot of rnaAggr gene expression
rnaAggr <- readRDS(here("project","analysis","dkd","rna_aggr_prep","step2_anno.rds"))
levels(rnaAggr) <- rev(levels(rnaAggr))
features <- c("SLC34A1","LRP2","SLC5A1","SLC5A2","HAVCR1",
              "VCAM1","CFH","SLC12A1","CLDN16","SLC12A3",
              "AQP2","SLC26A7","SLC26A4","NPHS2","FLT1",
              "PIEZO2","COL1A2","PTPRC","CD3E","MS4A1","CSF1R")
p1 <- DotPlot(rnaAggr, assay="SCT", features = features, cols = c("lightyellow","royalblue")) +
  RotatedAxis() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) #820x600
pdf(here(figures,"sfigure3.pdf"), width=10, height=6)
print(p1)
dev.off()
#################################################################
# draw ATP1B1 gene model peak coverage
# edit afterwards in inskcape / adobe illustrator etc.
library(Signac)
library(Seurat)
library(here)
library(dplyr)
library(tibble)
library(openxlsx)
library(plyranges)
library(data.table)

figures <- here("project","analysis","dkd","figures")
atac_aggr_prep <- here("project","analysis","dkd","atac_aggr_prep")
atacAggr <- readRDS(here(atac_aggr_prep,"step6_ccan.rds"))
DefaultAssay(atacAggr) <- "peaks"
Idents(atacAggr) <- paste0(atacAggr@meta.data$celltype,"_",atacAggr@meta.data$diabetes)

# cell-specific DAR for dkd vs.control
file <- here("project","analysis","dkd","markers","dar.macs2.celltype.diab_vs_ctrl.xlsx")
idents <- getSheetNames(file)
dar.df <- lapply(idents, function(ident){
  df <- read.xlsx(file, sheet = ident, rowNames = TRUE) %>%
    dplyr::filter(p_val_adj < 0.05) %>%
    dplyr::mutate(abs_log2FC = abs(avg_log2FC)) %>%
    dplyr::filter(abs_log2FC > 0.1) %>%
    rownames_to_column(var = "peak")
  if(nrow(df) > 0) { df$celltype <- ident }
    return(df)
}) %>% bind_rows()

dar.gr <- StringToGRanges(dar.df$peak)

# flank the gene coordinates with window
plot.gr <- StringToGRanges("chr1-169106683-169135009")
window <- 20000
start(plot.gr) <- start(plot.gr) - window
end(plot.gr) <- end(plot.gr) + window

file <- here("project","cut_and_run","hTERT_RPTEC","GR","GR_NT","hTERT_GR_consensus.bed")
GRpeak.gr <- fread(file) %>%
  dplyr::rename(chrom = V1, start = V2, end = V3) %>%
  makeGRangesFromDataFrame()
GRpeak.gr <- join_overlap_intersect(GRpeak.gr, plot.gr)

# intersect plotting region with dar
select.gr <- join_overlap_intersect(dar.gr, plot.gr)

peaks.plot <- PeakPlot(atacAggr, region = plot.gr)
dar.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=select.gr)
gr.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=GRpeak.gr)
ccan.plot <- LinkPlot(atacAggr, region= plot.gr, min.cutoff=0.4)

# combine tracks
plot <- CombineTracks(list(cp, peaks.plot, dar.plot, gr.plot, ccan.plot))

# this will print coverage plot with the links
pdf(here(figures, "sfigure_PT_ATP1B1.pdf"))
print(plot)
dev.off()

cp <- CoveragePlot(atacAggr, ident=c("TAL1_0","TAL1_1"), region = plot.gr, peaks=TRUE, links=FALSE)
ccan.plot <- LinkPlot(atacAggr, region = plot.gr, min.cutoff=0.4)
dar.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=select.gr)
gr.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=GRpeak.gr)
plot <- CombineTracks(list(cp, dar.plot, gr.plot, ccan.plot))

# this will print coverage plot with the links
pdf(here(figures, "sfigure_TAL1_ATP1B1.pdf"))
print(plot)
dev.off()

cp <- CoveragePlot(atacAggr, ident=c("TAL2_0","TAL2_1"), region = plot.gr, peaks=TRUE, links=FALSE)
ccan.plot <- LinkPlot(atacAggr, region = plot.gr, min.cutoff=0.4)
dar.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=select.gr)
plot <- CombineTracks(list(cp,dar.plot, gr.plot, ccan.plot))

# this will print coverage plot with the links
pdf(here(figures, "sfigure_TAL2_ATP1B1.pdf"))
print(plot)
dev.off()
#############################################
# ALDOB
file <- here("project","analysis","dkd","markers","dar.macs2.celltype.diab_vs_ctrl.xlsx")
idents <- getSheetNames(file)
dar.df <- lapply(idents, function(ident){
  df <- read.xlsx(file, sheet = ident, rowNames = TRUE) %>%
    dplyr::filter(p_val_adj < 0.05) %>%
    dplyr::mutate(abs_log2FC = abs(avg_log2FC)) %>%
    rownames_to_column(var = "peak")
  if(nrow(df) > 0) { df$celltype <- ident }
    return(df)
}) %>% bind_rows()
dar.gr <- StringToGRanges(dar.df$peak)

# flank the gene coordinates with window
plot.gr <- StringToGRanges("chr9-101421439-101449664")
start(plot.gr) <- start(plot.gr) - 20000
end(plot.gr) <- end(plot.gr) + 100000

# intersect plotting region with dar
select.gr <- join_overlap_intersect(dar.gr, plot.gr)

gr.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=GRpeak.gr)
gr.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=GRpeak.gr)

# gene plot
cp <- CoveragePlot(atacAggr, ident=c("PCT_0","PCT_1"), region = plot.gr, peaks=TRUE, links=FALSE)
ccan.plot <- LinkPlot(atacAggr, region = plot.gr, min.cutoff=0.7)
dar.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=select.gr)
plot <- CombineTracks(list(cp,dar.plot, gr.plot, ccan.plot))

# this will print coverage plot with the links
pdf(here(figures, "sfigure_ALDOB.pdf"))
print(plot)
dev.off()

#############################################
# G6PC
file <- here("project","analysis","dkd","markers","dar.macs2.celltype.diab_vs_ctrl.xlsx")
idents <- getSheetNames(file)
dar.df <- lapply(idents, function(ident){
  df <- read.xlsx(file, sheet = ident, rowNames = TRUE) %>%
    dplyr::filter(p_val_adj < 0.05) %>%
    dplyr::mutate(abs_log2FC = abs(avg_log2FC)) %>%
    rownames_to_column(var = "peak")
  if(nrow(df) > 0) { df$celltype <- ident }
    return(df)
}) %>% bind_rows()
dar.gr <- StringToGRanges(dar.df$peak)

# flank the gene coordinates with window
plot.gr <- StringToGRanges("chr17-42900799-42914438")
start(plot.gr) <- start(plot.gr) - 100000
end(plot.gr) <- end(plot.gr) + 100000

# intersect plotting region with dar
select.gr <- join_overlap_intersect(dar.gr, plot.gr)

gr.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=GRpeak.gr)
gr.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=GRpeak.gr)

# gene plot
cp <- CoveragePlot(atacAggr, ident=c("PCT_0","PCT_1"), region = plot.gr, peaks=TRUE, links=FALSE)
ccan.plot <- LinkPlot(atacAggr, region = plot.gr, min.cutoff=0.4)
dar.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=select.gr)
plot <- CombineTracks(list(cp,dar.plot, gr.plot, ccan.plot))

# this will print coverage plot with the links
pdf(here(figures, "sfigure_G6PC.pdf"))
print(plot)
dev.off()

#############################################
# FBP1
file <- here("project","analysis","dkd","markers","dar.macs2.celltype.diab_vs_ctrl.xlsx")
idents <- getSheetNames(file)
dar.df <- lapply(idents, function(ident){
  df <- read.xlsx(file, sheet = ident, rowNames = TRUE) %>%
    dplyr::filter(p_val_adj < 0.05) %>%
    dplyr::mutate(abs_log2FC = abs(avg_log2FC)) %>%
    rownames_to_column(var = "peak")
  if(nrow(df) > 0) { df$celltype <- ident }
    return(df)
}) %>% bind_rows()
dar.gr <- StringToGRanges(dar.df$peak)

# flank the gene coordinates with window
plot.gr <- StringToGRanges("chr9-94603141-94640249")
start(plot.gr) <- start(plot.gr) - 50000
end(plot.gr) <- end(plot.gr) + 50000

# intersect plotting region with dar
select.gr <- join_overlap_intersect(dar.gr, plot.gr)

gr.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=GRpeak.gr)
gr.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=GRpeak.gr)

# gene plot
cp <- CoveragePlot(atacAggr, ident=c("PCT_0","PCT_1"), region = plot.gr, peaks=TRUE, links=FALSE)
ccan.plot <- LinkPlot(atacAggr, region = plot.gr, min.cutoff=0.4)
dar.plot <- PeakPlot(atacAggr, region = plot.gr, peaks=select.gr)
plot <- CombineTracks(list(cp,dar.plot,gr.plot, ccan.plot))

# this will print coverage plot with the links
pdf(here(figures, "sfigure_FBP1.pdf"))
print(plot)
dev.off()


